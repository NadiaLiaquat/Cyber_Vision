

import keras.utils as image
from PIL import ImageFile


ImageFile.LOAD_TRUNCATED_IMAGES = True
import tensorflow as tf
import numpy as np
from keras.models import load_model
from keras.preprocessing import image
from keras.utils import load_img
import tensorflow as tf
import os


class MalwareDetectionCNN:
    def __init__(self, imagePath):
        self.imagePath = imagePath

    def detectMalware_CNN(self):
        # model = load_model('E:\Python-Projects\pdf2anki1\modelMalwareDetection_one.h5')
        # model = load_model('E:\Python-Projects\Front_end\Backend2\Models\modelMalwareDetection_one.h5')
        current_dir = os.path.dirname(__file__)
        model_path = os.path.join(current_dir, 'Models', 'modelMalwareDetection_one.h5')
        model = load_model(model_path)
        # os.makedirs('Front_end/Backend2/Models', exist_ok=True)
        # model = f'Front_end/Backend2/Models/modelMalwareDetection_one.h5'

        # try:
        #     os.makedirs('Front_end/Backend2/Models', exist_ok=True)
        #     model = f'Front_end/Backend2/Models/modelMalwareDetection_one.h5'
        #     print(model)
        #
        # except Exception as e:
        #     print(f"Malware_DetectionCNN Path issue is {str(e)}")

        img_height, img_width = 64, 64
        img_path = self.imagePath
        # Load and preprocess the input image
        # img = image.load_img(img_path, target_size=(img_height, img_width))
        img = tf.keras.utils.load_img(img_path, target_size=(img_height, img_width))
        img_array = tf.keras.preprocessing.image.img_to_array(img)
        img_array = np.array(img).astype(np.float32)
        img_array = np.expand_dims(img_array, axis=0)
        img_array /= 255.

        prediction = model.predict(img_array)
        predicted_class = np.argmax(prediction, axis=1)

        class_label = predicted_class[0]
        get_confidence = prediction[0][class_label]

        class_labels = ["Not Malware", "Malware"]

        get_MalwareFamily = class_labels[class_label]
        confidence = int(get_confidence * 100)
        return get_MalwareFamily, confidence



